<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Babble Mobile üí¨</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Babble">
    <meta name="theme-color" content="#0f172a">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/589/589708.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/emoji-mart@latest/dist/browser.js"></script>
    
    <style>
        :root { --vh: 1vh; }
        html, body { height: 100%; height: calc(var(--vh) * 100); margin: 0; overflow: hidden; background-color: #0f172a; touch-action: manipulation; }
        .chat-area { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-bottom: 20px; }
        em-emoji-picker { position: absolute; bottom: 90px; left: 5%; right: 5%; width: 90% !important; z-index: 50; display: none; height: 350px !important; }
        .tick { font-size: 10px; margin-left: 4px; }
        input, button { font-size: 16px !important; }
        
        .no-save {
            -webkit-touch-callout: none !important;
            -webkit-user-select: none !important;
            user-select: none !important;
            pointer-events: none !important;
            -webkit-user-drag: none !important;
        }
        .img-container { position: relative; overflow: hidden; border-radius: 1rem; background: #000; }
        .img-shield { position: absolute; inset: 0; z-index: 100; background: transparent; }
        .watermark-overlay {
            position: absolute; inset: 0; z-index: 25; pointer-events: none;
            display: flex; flex-wrap: wrap; gap: 8px; opacity: 0.1;
            font-size: 8px; font-weight: bold; color: white; overflow: hidden;
        }
    </style>
</head>
<body class="flex flex-col text-white font-sans overflow-hidden">

    <header class="bg-gray-800/90 backdrop-blur-lg p-4 border-b border-gray-700 flex justify-between items-center z-10 sticky top-0">
        <div class="flex items-center space-x-2">
            <span class="text-2xl">üí¨</span>
            <h1 class="text-xl font-black tracking-tighter text-blue-400">BABBLE</h1>
        </div>
        <div class="flex items-center space-x-3">
            <div id="ping-display" class="hidden text-[10px] font-mono text-gray-400 bg-black/40 px-2 py-1 rounded-lg">-- ms</div>
            <div id="status-dot" class="h-3 w-3 rounded-full bg-red-500 shadow-[0_0_10px_rgba(239,68,68,0.5)]"></div>
        </div>
    </header>

    <main class="flex-1 flex flex-col p-4 w-full max-w-xl mx-auto overflow-hidden relative">
        <div id="setup" class="space-y-6 mt-4">
            <div class="bg-gray-800/50 p-8 rounded-[2rem] border border-gray-700 text-center shadow-2xl backdrop-blur-sm">
                <p class="text-[10px] text-gray-500 mb-2 font-black uppercase tracking-widest">Your Private Node</p>
                <div id="my-id" class="text-lg font-mono text-blue-300 break-all py-4 px-4 bg-black/40 rounded-2xl border border-gray-700 select-all mb-4">Initialising...</div>
                <button id="share-btn" class="w-full bg-blue-500/10 text-blue-400 border border-blue-500/40 py-4 rounded-2xl font-black text-sm active:bg-blue-500/20">
                    üîó COPY INVITE LINK
                </button>
            </div>
            <div class="space-y-3">
                <input type="text" id="peer-id-input" placeholder="Paste friend's ID..." class="w-full bg-gray-800 p-5 rounded-2xl border border-gray-700 focus:outline-none text-white">
                <button id="connect-btn" class="w-full bg-blue-600 active:scale-[0.98] py-5 rounded-2xl font-black text-xl">START CHAT üöÄ</button>
            </div>
        </div>

        <div id="chat-window" class="hidden flex flex-col h-full overflow-hidden">
            <div id="messages" class="chat-area space-y-4"></div>
            <div id="typing-indicator" class="hidden text-[10px] text-gray-500 font-bold uppercase ml-2 mb-2 italic">typing...</div>
            <div id="picker-container"></div>
            <div class="flex items-center space-x-2 bg-gray-800/80 backdrop-blur-xl p-2 rounded-[1.5rem] border border-gray-700 mb-1">
                <button id="emoji-trigger" class="w-12 h-12 text-2xl">üòÄ</button>
                <button onclick="document.getElementById('file-input').click()" class="w-12 h-12 text-2xl text-gray-400">üìé</button>
                <button onclick="document.getElementById('camera-input').click()" class="w-12 h-12 text-2xl">üì∏</button>
                
                <input type="file" id="file-input" class="hidden" accept="image/*, .pdf, .txt, .docx">
                <input type="file" id="camera-input" class="hidden" accept="image/*" capture="environment">
                
                <input type="text" id="msg-input" placeholder="Message" class="flex-1 bg-transparent p-3 focus:outline-none text-white">
                <button id="send-btn" class="bg-blue-600 w-12 h-12 flex items-center justify-center rounded-2xl">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 rotate-45 fill-white" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </button>
            </div>
        </div>
    </main>

    <script>
        let vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);

        const MAX_FILE_SIZE = 50 * 1024 * 1024;
        const peer = new Peer();
        let connection;
        let myFullId = "";

        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            if (params.get('id')) document.getElementById('peer-id-input').value = params.get('id');
        };

        document.getElementById('share-btn').addEventListener('click', () => {
            const url = `${window.location.origin}${window.location.pathname}?id=${myFullId}`;
            navigator.clipboard.writeText(url).then(() => {
                document.getElementById('share-btn').innerText = "‚úÖ COPIED!";
                setTimeout(() => document.getElementById('share-btn').innerText = "üîó COPY INVITE LINK", 2000);
            });
        });

        const messagesDiv = document.getElementById('messages');
        const msgInput = document.getElementById('msg-input');
        const setupWindow = document.getElementById('setup');
        const chatWindow = document.getElementById('chat-window');

        peer.on('open', (id) => {
            myFullId = id;
            document.getElementById('my-id').innerText = id;
            document.getElementById('status-dot').className = "h-3 w-3 rounded-full bg-yellow-500";
        });

        peer.on('connection', setupConnection);
        document.getElementById('connect-btn').addEventListener('click', () => {
            const id = document.getElementById('peer-id-input').value.trim();
            if (id) setupConnection(peer.connect(id));
        });

        document.addEventListener('visibilitychange', () => {
            if (connection && connection.open) {
                connection.send({ 
                    type: 'visibility', 
                    status: document.hidden ? 'away' : 'back' 
                });
            }
        });

        function setupConnection(conn) {
            connection = conn;

            connection.on('open', () => {
                setupWindow.classList.add('hidden');
                chatWindow.classList.remove('hidden');
                document.getElementById('status-dot').className = "h-3 w-3 rounded-full bg-green-500";
                document.getElementById('ping-display').classList.remove('hidden');
                addSystemMessage("Peer joined the session üü¢");
            });

            connection.on('close', () => {
                document.getElementById('status-dot').className = "h-3 w-3 rounded-full bg-red-500";
                addSystemMessage("Peer left the session üî¥");
            });

            setInterval(() => { if(connection.open) connection.send({ type: 'ping', time: Date.now() }); }, 3000);

            connection.on('data', (data) => {
                if (data.type === 'ping') { connection.send({ type: 'pong', time: data.time }); return; }
                if (data.type === 'pong') { 
                    document.getElementById('ping-display').innerText = `${Date.now() - data.time}ms`;
                    return; 
                }
                if (data.type === 'typing') { document.getElementById('typing-indicator').classList.remove('hidden'); return; }
                
                if (data.type === 'visibility') {
                    if (data.status === 'away') addSystemMessage("Peer minimized the app ‚ö†Ô∏è");
                    if (data.status === 'back') addSystemMessage("Peer is back üëÅÔ∏è");
                    return;
                }

                document.getElementById('typing-indicator').classList.add('hidden');
                if (data.file) displayFile(data.file, data.fileType, data.fileName, 'friend');
                else addMessage(data.text, 'friend');
            });
        }

        function addSystemMessage(text) {
            const div = document.createElement('div');
            div.className = "w-full flex justify-center my-2";
            div.innerHTML = `<span class="bg-black/20 text-[10px] font-bold uppercase tracking-widest px-3 py-1 rounded-full text-gray-400">${text}</span>`;
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function displayFile(blobData, type, name, sender) {
            const url = URL.createObjectURL(new Blob([blobData], { type: type }));
            let content;
            if (type.startsWith('image/')) {
                const id = `img-${Date.now()}`;
                content = `
                    <div class="img-container" id="${id}">
                        <div class="img-shield" oncontextmenu="return false;"></div>
                        <div id="blur-${id}" class="absolute inset-0 z-50 backdrop-blur-3xl bg-gray-900/90 flex flex-col items-center justify-center p-4">
                            <span class="text-2xl mb-2">üîí</span>
                            <p class="text-[10px] font-black text-blue-400 uppercase">Hold to View</p>
                        </div>
                        <div class="watermark-overlay">${Array(15).fill('PRIVATE').join(' ')}</div>
                        <img src="${url}" class="w-full no-save opacity-0 transition-opacity duration-300" id="raw-${id}">
                        <div id="timer-badge-${id}" class="hidden absolute bottom-2 right-2 z-[60] bg-red-600 text-[8px] px-2 py-1 rounded-full font-bold">
                            DESTROYS IN <span id="timer-${id}">10</span>s
                        </div>
                    </div>`;

                setTimeout(() => {
                    const shield = document.querySelector(`#${id} .img-shield`);
                    const blur = document.getElementById(`blur-${id}`);
                    const img = document.getElementById(`raw-${id}`);
                    const badge = document.getElementById(`timer-badge-${id}`);
                    let timerStarted = false;
                    let timeLeft = 10;
                    
                    const show = () => { 
                        blur.style.opacity = '0'; 
                        img.style.opacity = '1'; 
                        if (!timerStarted) {
                            timerStarted = true;
                            badge.classList.remove('hidden');
                            const timer = setInterval(() => {
                                timeLeft--;
                                const el = document.getElementById(`timer-${id}`);
                                if (el) el.innerText = timeLeft;
                                if (timeLeft <= 0) {
                                    clearInterval(timer);
                                    document.getElementById(id).innerHTML = `<div class="p-6 text-center text-gray-600 text-[10px] font-black italic uppercase">üî• Image Expired</div>`;
                                    URL.revokeObjectURL(url);
                                }
                            }, 1000);
                        }
                    };
                    const hide = () => { blur.style.opacity = '1'; img.style.opacity = '0'; };
                    shield.addEventListener('touchstart', show); shield.addEventListener('touchend', hide);
                    shield.addEventListener('mousedown', show); shield.addEventListener('mouseup', hide);
                }, 100);
            } else {
                content = `<a href="${url}" download="${name}" class="text-blue-400 underline font-bold">üìÅ ${name}</a>`;
            }
            addMessage(content, sender, true);
        }

        const handleFileUpload = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                if (connection) {
                    connection.send({ file: reader.result, fileName: file.name, fileType: file.type });
                    displayFile(reader.result, file.type, file.name, 'me');
                }
            };
            reader.readAsArrayBuffer(file);
            e.target.value = ''; // Reset for same-file re-upload
        };

        document.getElementById('file-input').addEventListener('change', handleFileUpload);
        document.getElementById('camera-input').addEventListener('change', handleFileUpload);

        document.getElementById('send-btn').addEventListener('click', () => {
            const text = msgInput.value.trim();
            if (text && connection) {
                connection.send({ text: text });
                addMessage(text, 'me');
                msgInput.value = '';
            }
        });

        function addMessage(content, sender, isHTML = false) {
            const div = document.createElement('div');
            const isMe = sender === 'me';
            div.className = `flex w-full ${isMe ? 'justify-end' : 'justify-start'} mb-4 px-1`;
            div.innerHTML = `<div class="max-w-[88%] px-5 py-4 rounded-[1.5rem] ${isMe ? 'bg-blue-600 rounded-tr-none' : 'bg-gray-800 border border-gray-700 rounded-tl-none'} shadow-2xl">
                ${isHTML ? content : `<p class="text-[15px] font-medium leading-relaxed">${content}</p>`}
            </div>`;
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    </script>
</body>
</html>